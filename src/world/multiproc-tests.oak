
;; regression tests start here...

(process-id (current-process))
(%heavyweight-thread start-busy-work)

(define x (make mutex))
(acquire-mutex x)
(release-mutex x)

(define y (delay (+ 1 2)))
(define z (future (+ 1 2)))

(define (test-fn)
  (while t (format t "~s~%" (process-id (current-process)))))
(process-run-fn test-fn nil)
(process-run-fn test-fn nil)
(process-run-fn test-fn nil)
(test-fn)

(set! (fluid thing) 'adf)
(fluid thing)	;Should return symbol ADF

(bind (((fluid hello) "hello")) (fluid hello))	;Returns "hello"
(fluid hello)	;Should error

(bind (((fluid hello) "hello")) (set! (fluid world) "world"))
(fluid world)	;Returns "world"
(fluid hello)  	;Should error

(set! #*forcible-print-magic #f)


;;; TO DO

;;; register for # instructions until alarms ?
;;; at least make interval modifiable

;;; change C thread maker so malloc'ed stuff doesn't get into oaklisp space

;;; rationalize process descriptor table C vs Oaklisp interface

;;; process priorities

;;; make threads extra "level" in build process.  Prior to that being
;;; loaded, NO THREAD STUFF AT ALL.

;;; ability to build emulator without thread support

;;; race conditions (symbol tables, hash tables, add-method)

;;; performance

;;; make sure throwing out of thread gets an error


;;; completely rewrite allocation subsystem
